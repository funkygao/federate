File: build-rpm.go
Content:
```
package image

import (
	"fmt"
	"log"
	"os"
	"os/exec"
	"time"

	"federate/internal/fs"
	"github.com/AlecAivazis/survey/v2"
	"github.com/spf13/cobra"
)

const jmxExporterPortBase = 10000

var (
	appName           string
	appSourcePath     string
	tomcatPort        int
	jvmSize           string
	cpuAffinity       string
	mainModule        string
	debugImage        bool
	defaultRpmRelease = time.Now().Format("20060102150405")
	rpmRelease        string
)

var buildRpmCmd = &cobra.Command{
	Use:   "build-rpm",
	Short: "Build app into RPM to upload to yum repo for automatic deployment",
	Long: `Build app into RPM to upload to yum repo for automatic deployment.

Example Makefile:
package:
	@mvn package -U -Dmaven.test.skip=true -T8

build-rpm:package
	@federate image build-rpm --app-name wms-outbound --app-source-path wms-outbound-web/target/wms-outbound-web-1.0.0-SNAPSHOT-package --jvm-size large --main-module com.jdwl.wms.WebApplication --tomcat-port 8098`,
	Run: func(cmd *cobra.Command, args []string) {
		buildRPM()
	},
}

func buildRPM() {
	dockerImage := "rpm-" + appName
	if debugImage {
		if appName == "" {
			fmt.Println("--app-name must be provided")
			return
		}
		log.Printf(`docker run -it --rm --entrypoint /bin/bash %s`, dockerImage)
		return
	}
	// å®šä¹‰éœ€è¦æç¤ºçš„ survey é—®é¢˜
	questions := []*survey.Question{}

	if appName == "" {
		questions = append(questions, &survey.Question{
			Name:     "appName",
			Prompt:   &survey.Input{Message: "è¯·è¾“å…¥åº”ç”¨åç§° (APP_NAME):"},
			Validate: survey.Required,
		})
	}

	if appSourcePath == "" {
		questions = append(questions, &survey.Question{
			Name:     "appSourcePath",
			Prompt:   &survey.Input{Message: "è¯·è¾“å…¥åº”ç”¨æ‰“åŒ…æˆå“è·¯å¾„ï¼Œä¾‹å¦‚ï¼šwms-outbound-web/target/wms-outbound-web-1.0.0-SNAPSHOT-package (APP_SOURCE_PATH):"},
			Validate: survey.Required,
		})
	}

	if tomcatPort == 0 {
		questions = append(questions, &survey.Question{
			Name:     "tomcatPort",
			Prompt:   &survey.Input{Message: "è¯·è¾“å…¥ TOMCAT ç«¯å£ (TOMCAT_PORT):"},
			Validate: survey.Required,
		})
	}

	if jvmSize == "" {
		questions = append(questions, &survey.Question{
			Name: "jvmSize",
			Prompt: &survey.Select{
				Message: "è¯·è¾“å…¥ JVM å¤§å° (JVM_SIZE):",
				Options: []string{"large", "medium", "small"},
				Default: "medium",
			},
		})
	}

	if mainModule == "" {
		questions = append(questions, &survey.Question{
			Name:     "mainModule",
			Prompt:   &survey.Input{Message: "è¯·è¾“å…¥ Main Moduleï¼Œä¾‹å¦‚ï¼šcom.jdwl.wms.WebApplication (MAIN_MODULE):"},
			Validate: survey.Required,
		})
	}

	// å¦‚æœæœ‰éœ€è¦æç¤ºçš„é—®é¢˜ï¼Œåˆ™ä½¿ç”¨ survey è·å–ç”¨æˆ·è¾“å…¥
	if len(questions) > 0 {
		answers := struct {
			AppName       string
			AppSourcePath string
			TomcatPort    int
			JvmSize       string
			CpuAffinity   string
			MainModule    string
		}{}

		err := survey.Ask(questions, &answers)
		if err != nil {
			log.Fatalf("æ— æ³•è·å–è¾“å…¥: %v", err)
		}

		// ä»…åœ¨æœªé€šè¿‡ flag æä¾›æ—¶æ›´æ–°å˜é‡
		if appName == "" {
			appName = answers.AppName
		}
		if appSourcePath == "" {
			appSourcePath = answers.AppSourcePath
		}
		if tomcatPort == 0 {
			tomcatPort = answers.TomcatPort
		}
		if jvmSize == "" {
			jvmSize = answers.JvmSize
		}
		if mainModule == "" {
			mainModule = answers.MainModule
		}
	}

	// æ£€æŸ¥æ‰€æœ‰å¿…éœ€å‚æ•°æ˜¯å¦å·²æä¾›
	if appName == "" || appSourcePath == "" || tomcatPort == 0 || jvmSize == "" || mainModule == "" {
		log.Fatalf("æ‰€æœ‰å¿…éœ€å‚æ•°éƒ½å¿…é¡»æä¾›: app-name, app-source-path, tomcat-port, jvm-size, main-module")
	}

	// è®°å½•å¼€å§‹æ—¶é—´
	startTime := time.Now()

	jmxExporterPort := jmxExporterPortBase + tomcatPort

	// ç”Ÿæˆä¸­é—´æ–‡ä»¶
	fs.GenerateFileFromTmpl("templates/image/Dockerfile.rpmbuilder", "Dockerfile.rpmbuilder", nil)
	fs.GenerateFileFromTmpl("templates/image/config_rpm.sh", "config_rpm.sh", map[string]string{
		"TOMCAT_PORT":       fmt.Sprintf("%d", tomcatPort),
		"JMX_EXPORTER_PORT": fmt.Sprintf("%d", jmxExporterPort),
		"JVM_SIZE":          jvmSize,
		"CPU_AFFINITY":      cpuAffinity,
	})
	fs.GenerateFileFromTmpl("templates/image/build_rpm.sh", "build_rpm.sh", nil)
	fs.GenerateFileFromTmpl("templates/image/myapp.spec.template", "myapp.spec.template", nil)
	fs.GenerateFileFromTmpl("templates/image/run.sh", "run.sh", map[string]string{
		"MAIN_MODULE": mainModule,
	})

	// Defer removal of temporary files
	tempFiles := []string{
		"Dockerfile.rpmbuilder",
		"config_rpm.sh",
		"build_rpm.sh",
		"myapp.spec.template",
		"run.sh",
	}
	defer func(files []string) {
		for _, file := range files {
			os.Remove(file)
		}
	}(tempFiles)

	log.Printf("æ­£åœ¨æ„å»º Docker é•œåƒ: %s ...", dockerImage)
	// docker build --help æ˜¾ç¤º: docker buildx buildï¼Œå®ƒå·²ç»é›†æˆäº† buildx åŠŸèƒ½
	dockerBuildCmd := exec.Command("docker", "build",
		"--platform", "linux/amd64",
		"-f", "Dockerfile.rpmbuilder",
		"--build-arg", "APP_NAME="+appName,
		"--build-arg", "APP_SOURCE_PATH="+appSourcePath,
		"-t", dockerImage,
		"--load", ".")
	dockerBuildCmd.Stdout = os.Stdout
	dockerBuildCmd.Stderr = os.Stderr
	if err := dockerBuildCmd.Run(); err != nil {
		for _, file := range tempFiles {
			os.Remove(file)
		}
		log.Fatalf("Docker build å¤±è´¥: %v", err)
	}

	// è·å–å½“å‰æ—¶é—´å¹¶æ ¼å¼åŒ–
	if rpmRelease == "" {
		rpmRelease = defaultRpmRelease
	}
	cwd, _ := os.Getwd()

	log.Println("æ­£åœ¨è¿è¡Œ Docker å®¹å™¨æ„å»º RPM...")
	dockerRunCmd := exec.Command("docker", "run", "--platform", "linux/amd64", "--rm", "-v", fmt.Sprintf("%s:/mac", cwd), "-e", fmt.Sprintf("RELEASE=%s", rpmRelease), dockerImage)
	dockerRunCmd.Stdout = os.Stdout
	dockerRunCmd.Stderr = os.Stderr
	if err := dockerRunCmd.Run(); err != nil {
		log.Fatalf("Docker run å¤±è´¥: %v", err)
	}

	// è®°å½•ç”Ÿæˆçš„ RPM æ–‡ä»¶å
	rpmFileName := fmt.Sprintf("%s-%s-%s.el7.x86_64.rpm", appName, "1.0.0", rpmRelease)
	log.Printf("ğŸº ç”Ÿæˆçš„ RPM æ–‡ä»¶åï¼š%s", rpmFileName)

	// è®¡ç®—å¹¶è¾“å‡ºè€—æ—¶
	elapsedTime := time.Since(startTime)
	log.Printf("æ“ä½œè€—æ—¶: %s\n", elapsedTime)
}

func init() {
	buildRpmCmd.Flags().StringVarP(&appName, "app-name", "a", "", "åº”ç”¨åç§°")
	buildRpmCmd.Flags().StringVarP(&appSourcePath, "app-source-path", "s", "", "åº”ç”¨æ‰“åŒ…æˆå“è·¯å¾„")
	buildRpmCmd.Flags().IntVarP(&tomcatPort, "tomcat-port", "t", 0, "TOMCAT ç«¯å£ (TOMCAT_PORT)")
	buildRpmCmd.Flags().StringVarP(&jvmSize, "jvm-size", "j", "medium", "JVM å¤§å° (JVM_SIZE)")
	buildRpmCmd.Flags().StringVarP(&cpuAffinity, "cpu-affinity", "c", "", "CPU äº²å’Œæ€§ (CPU_AFFINITY)")
	buildRpmCmd.Flags().StringVarP(&rpmRelease, "release", "r", defaultRpmRelease, "RPM Release Info")
	buildRpmCmd.Flags().StringVarP(&mainModule, "main-module", "m", "", "å¯åŠ¨ç±»")
	buildRpmCmd.Flags().BoolVarP(&debugImage, "debug", "d", false, "è¿›å…¥rpmæ„å»ºå®¹å™¨å†…éƒ¨")
}

```

@build-rpm.go
è¿è¡Œæ—¶ï¼Œ--jvm-size --main-module com.jdwl.wms.fusion.WmsStockSynergy
ä¼šå¯¼è‡´ jvmSize å€¼è¢«å†™æˆäº† --main-module


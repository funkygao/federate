# Generated by federate, DO NOT EDIT.
SHELL := /bin/bash
.SILENT:

FEDERATE_CMD ?= federate
INVENTORY_CMD := $(FEDERATE_CMD) util inventory
ENV ?=

help: 
	awk 'BEGIN {FS = ":.*##"; printf "Usage:\n  make \033[36mENV=<env> <target>\033[0m\n"} /^[a-zA-Z_0-9-]+:.*?##/ { printf "  \033[36m%-20s\033[0m %s\n", $$1, $$2 } /^##@/ { printf "\n\033[1m%s\033[0m\n", substr($$0, 5) } /^##[^@]/ { printf "%s\n", substr($$0, 4) }' $(MAKEFILE_LIST)

##@ Submodule

pull:clean ## Pull submodules up to latest remote commits.
	echo "‚òïÔ∏è Pulling submodules to latest remote commits ..."
	git submodule update --init --recursive --remote
	git diff --quiet --exit-code HEAD || echo "üç∫ Submodule hashes have changed. Manual commit required."

init:checkenv clean
	echo "‚òïÔ∏è Config all submodules repository for $$ENV environment"
	$(INVENTORY_CMD) -f init-submodules -e $$ENV | while read cmd; do \
		echo "   Executing: $$cmd"; \
		eval $$cmd; \
	done
	git submodule update --init --recursive
	echo "üç∫ Submodules synchronized for $$ENV environment."

dirty: ## Display local changes summary.
	git submodule foreach --recursive 'git diff --stat'

diff: ## Display local changes details.
	git submodule foreach --recursive 'git diff --ignore-space-at-eol -w -b --ignore-all-space --ignore-blank-lines'

stage:
	git submodule foreach 'if ! git diff --quiet; then git add . && echo "Changes staged"; fi'

clean:
	echo "‚òïÔ∏è Restoring submodules repository ..."
	for repo in $$($(INVENTORY_CMD) -f repo-list); do \
		if [ -d "$$repo" ]; then \
			echo "   Checking out $$repo"; \
			(cd $$repo && git checkout -q .) || echo "Failed to checkout $$repo"; \
		fi; \
	done
	rm -rf {{.FusionProjectName}}

checkenv:
	if [ -z "$(ENV)" ]; then \
		echo "Error: ENV is not set. Please use 'make ENV=<env>'"; \
		exit 1; \
	fi

##@ Fuse

fusion-start: ## Scaffold {{.FusionStarter}}: the fusion-starter module.
	federate microservice fusion-start

rebuild-starter:fusion-start package

consolidate: ## Initialize submodules, generate and pacakge the federated system.
	$(MAKE) init
	echo
	echo "‚òïÔ∏è Consolidating the federated project ..."
	federate microservice consolidate --yes --silent=false
	echo
	if [ "$(sci)" != "1" ]; then \
		echo "‚òïÔ∏è Local installing the Instrumented Components ..."; \
		for repo in $$($(INVENTORY_CMD) -f components); do \
			profile=$$($(INVENTORY_CMD) -f maven-profile -r $$repo -e $$ENV); \
			modules=$$($(INVENTORY_CMD) -f maven-modules -r $$repo); \
			echo "   Installing $$repo with profile:$$profile on modules:$$modules"; \
			(cd $$repo && mvn clean install -q -U -pl ":$$modules" -P"$$profile" -am -T8 -Dmaven.test.skip=true -Dfederate.packaging=true) || exit 1; \
		done; \
	else \
		echo "‚òïÔ∏è Skipped Components Installation"; \
	fi
	$(MAKE) package
	echo "üç∫ {{.FusionProjectName}} consolidated and packaged!"

run-local: ## Local debug {{.FusionProjectName}} after configuring hosts.
	$(MAKE) -C {{.FusionProjectName}} run-local

discover: ## Step by step guide for detecting potential conflicts.
	$(FEDERATE_CMD) debug wizard

inspect: ## Inspect indirect conflict risk before runtime.
	$(MAKE) -C {{.FusionProjectName}} inspect

optimize:
	federate microservice optimize --yes --verbosity 3

package:
	echo "‚òïÔ∏è Building {{.FusionProjectName}} ..."
	mvn install -q -T8 -Dmaven.artifact.threads=16
	echo "   {{.FusionProjectName}} packaged"

# handy local debug targets: manual update submodule files then install, ready for 'make run-local'
{{- range .Components }}

.PHONY: {{.}}
{{.}}:checkenv
	modules=$$($(INVENTORY_CMD) -f maven-modules -r {{.}}); \
	profile=$$($(INVENTORY_CMD) -f maven-profile -r {{.}} -e $$ENV); \
	(cd {{.}} && mvn install -pl ":$$modules" -P"$$profile" -am -T8 -Dmaven.test.skip=true -Dfederate.packaging=true)
	$(MAKE) package
{{- end }}
